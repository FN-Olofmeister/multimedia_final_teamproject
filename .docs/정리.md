# VideoNet Pro - 버그 수정 및 기능 추가 정리

---

## 🐛 해결한 버그

### 1. 백엔드 웹소켓과 FastAPI 포트 불일치
- **원인**: FastAPI와 Socket.IO가 각각 다른 포트에서 실행되어 연결 오류 발생
- **해결**: FastAPI와 Socket.IO를 하나의 앱으로 통합하여 같은 포트(7701)에서 실행

### 2. 웹소켓 중복 연결 오류
- **원인**: 페이지가 새로고침될 때 기존 연결을 정리하지 않고 새로 연결해서 이벤트가 중복 발생
- **해결**: 새 연결 전에 기존 연결이 있는지 확인하고, 페이지 이동 시 연결 해제 처리 추가

### 3. 방에 0명이어도 방이 남아있는 문제
- **원인**: 서버 재시작 시 메모리는 초기화되지만 데이터베이스의 방 상태가 그대로 유지됨
- **해결**: 서버 시작 시 모든 방을 비활성화 상태로 초기화 + 마지막 사람이 나가면 방 자동 삭제

### 4. 호스트가 2명으로 표시 / 실제 인원과 UI 불일치
- **원인**: React의 상태 업데이트 시 이전 값을 참조하는 클로저 문제
- **해결**: 상태 업데이트 시 콜백 함수 패턴 `setState(prev => ...)` 사용

### 5. 다크모드/라이트모드 동작 안 함
- **원인**: CSS 파일에 문법 오류가 있어서 스타일이 적용되지 않음
- **해결**: CSS 문법 오류 수정 + 테마별 스타일 클래스 시스템 구축

### 6. 파일 전송 시 이전 파일 정보가 남아있는 문제
- **원인**: 파일 전송 완료 후 상태 변수를 초기화하지 않음
- **해결**: 전송 완료 시 파일 정보, 통계 등 모든 상태 변수 초기화

### 7. 방 재입장 시 카메라 검은 화면
- **원인**: 방을 나갈 때 카메라 트랙이 종료되었는데, 재입장 시 종료된 트랙을 다시 사용하려 함
- **해결**: 재입장 시 트랙 상태를 확인하고, 종료된 상태면 새로 카메라 권한 요청

### 8. 상대방 퇴장 시 내 화면도 검은색
- **원인**: 상대방이 재입장할 때 기존 P2P 연결을 정리하지 않아서 충돌 발생
- **해결**: 재입장 시 기존 연결을 먼저 정리한 후 새 연결 생성

### 9. 영상 효과와 오디오 효과 동시 적용 시 충돌
- **원인**: 영상 효과 적용 버튼이 전체 스트림을 교체하면서 오디오 트랙도 덮어씀
- **해결**: 비디오 트랙과 오디오 트랙을 독립적으로 처리하여 서로 영향 없도록 분리

### 10. 웹캠 효과 적용 시 영상이 안 보임
- **원인**: 비디오 메타데이터(크기 정보)가 로딩되기 전에 처리를 시작해서 0×0 크기로 출력
- **해결**: 메타데이터 로딩이 완료될 때까지 대기한 후 처리 시작

### 11. 오디오 효과가 안 들림
- **원인**: 효과음 볼륨이 0으로 설정되어 있었음
- **해결**: 효과음 볼륨을 적절한 값(0.7)으로 수정

### 12. 라이트모드에서 버튼이 안 보임
- **원인**: 버튼 색상이 다크모드 전용으로 하드코딩되어 배경과 동일해짐
- **해결**: 테마에 따라 버튼 색상이 자동으로 바뀌도록 수정

### 13. Tailwind CSS 클래스 오타
- **원인**: `dark: text-white`처럼 콜론 뒤에 공백이 있어서 적용 안 됨
- **해결**: `dark:text-white`로 공백 제거

### 14. 파일 선택 input 속성 중복
- **원인**: 같은 속성이 2번 작성되어 HTML 경고 발생
- **해결**: 중복 속성 제거

---

## ✨ 추가한 기능

### 1. 다크모드 / 라이트모드
- **구현**: HTML 태그에 `data-theme` 속성을 추가하고, CSS에서 테마별 스타일 정의
- **저장**: LocalStorage에 사용자 선택을 저장하여 새로고침해도 유지

### 2. 서버 시작 시 방 자동 초기화
- **구현**: FastAPI 서버 시작 이벤트에서 SQL로 모든 방을 비활성화
- **목적**: 서버 재시작 후 좀비 방이 남아있는 문제 방지

### 3. 빈 방 자동 삭제
- **구현**: 마지막 참가자가 방을 나갈 때 Socket.IO 이벤트에서 DB 삭제 실행
- **목적**: 사용하지 않는 방이 계속 쌓이는 것 방지

### 4. 웹캠 실시간 압축 품질 분석
- **구현**: OpenCV로 이미지 압축 + scikit-image로 PSNR/SSIM 계산 + Recharts로 그래프 표시
- **PSNR**: 원본과 압축본의 차이를 dB 단위로 측정 (높을수록 좋음)
- **SSIM**: 구조적 유사도를 0~1 사이로 측정 (1에 가까울수록 좋음)

### 5. 파일 전송 무결성 검증
- **구현**: Web Crypto API의 SHA256 해시 함수 사용
- **방식**: 보내는 쪽에서 해시 계산 → 받는 쪽에서 다시 계산 → 두 값 비교

### 6. 웹캠 영상 효과 (6종)
- **구현**: Canvas API의 `getImageData()`로 픽셀 데이터 추출 → 각 픽셀 값 변환 → `putImageData()`로 적용
- **흑백**: RGB 값을 가중 평균으로 변환 `(0.299×R + 0.587×G + 0.114×B)`
- **세피아**: RGB 값에 세피아 톤 매트릭스 적용
- **블러**: CSS `filter: blur()` 속성 사용
- **엣지 감지**: Sobel 필터 커널로 가장자리 검출
- **카툰**: 색상 양자화(단순화) + 엣지 강조
- **네온**: 색상 반전 + 글로우 효과

### 7. 웹캠 기하 변환 효과
- **구현**: Canvas의 `scale()`, `transform()` 메서드 사용
- **좌우 반전**: `scale(-1, 1)` - X축 뒤집기
- **상하 반전**: `scale(1, -1)` - Y축 뒤집기
- **45° 전단**: `transform(1, 0, tan(45°), 1, 0, 0)` - 비스듬하게 기울이기
- **90° 전단**: 극단적인 기울임 효과

### 8. 웹캠 오디오 효과 (3종)
- **구현**: Web Audio API 노드들을 체인으로 연결 `source → 효과 → destination`
- **Low Pass Filter**: `BiquadFilterNode`로 고주파 차단 (뭉개진 소리)
- **Echo**: `DelayNode` + `GainNode`로 딜레이된 소리 반복
- **Reverb**: `ConvolverNode`로 잔향 효과 (넓은 공간에 있는 것 같은 느낌)

### 9. 효과 토글형 즉시 적용
- **이전**: "영상 효과 적용" 버튼을 따로 클릭해야 적용됨
- **변경**: 체크박스 클릭 시 바로 효과 적용
- **구현**: `replaceTrack()` 메서드로 연결 재협상 없이 트랙만 교체

### 10. 방 리스트 실시간 업데이트
- **구현**: Socket.IO `room_list_updated` 이벤트 수신 시 방 목록 새로고침
- **백업**: 이벤트가 누락될 경우 대비 10초마다 폴링으로 갱신

### 11. WebRTC 연결 상태 검증
- **구현**: offer/answer 생성 전에 `signalingState` 확인
- **목적**: 잘못된 상태에서 시그널링 시도하면 오류 발생하므로 사전 방지

---

## 📅 작업 일정

| 날짜 | 작업 내용 |
|------|-----------|
| 11/25 | 프로젝트 구조 정리, 포트 통합, 기본 버그 수정 |
| 11/27 | 압축 품질 분석 기능, 웹캠 효과 기능 추가 |
| 11/27 | 웹캠 효과 버그 수정 (메타데이터 로딩, 오디오 볼륨) |
| 11/28 | 다크모드 기능 병합 |
| 11/30 | P0 버그 5개 수정, UI 테마 전체 적용 |

---

## 🛠 사용한 핵심 기술

| 기술 | 용도 |
|------|------|
| **WebRTC** | P2P 화상통화 (서버 거치지 않고 직접 연결) |
| **Socket.IO** | 실시간 양방향 통신 (방 입장/퇴장, 채팅 등) |
| **Canvas API** | 실시간 영상 효과 처리 (픽셀 단위 조작) |
| **Web Audio API** | 실시간 오디오 효과 처리 (필터, 에코, 리버브) |
| **OpenCV** | 이미지 압축 처리 |
| **scikit-image** | 이미지 품질 지표 계산 (PSNR, SSIM) |
| **Recharts** | 그래프 시각화 |
