# 🛠️ VideoNet Pro - 버그 수정 및 기능 추가 내역

> **프로젝트**: VideoNet Pro - WebRTC 기반 화상회의 플랫폼
> **작업 기간**: 2025년 11월 ~ 12월
> **목적**: 기존 미완성 프로젝트의 버그 수정 및 새로운 기능 추가

---

## 📋 목차

1. [해결한 버그](#-해결한-버그)
2. [추가한 기능](#-추가한-기능)
3. [작업 타임라인](#-작업-타임라인)

---

## 🐛 해결한 버그

### 1. 백엔드 포트 불일치 문제

**문제 상황:**
- FastAPI 서버와 WebSocket(Socket.IO) 서버가 서로 다른 포트에서 실행됨
- 프론트엔드에서 API는 연결되는데 실시간 통신이 안 되는 상황

**해결 방법:**
- Socket.IO를 FastAPI에 통합하여 **하나의 포트(7701)**에서 모두 처리
- `main:combined_app`으로 통합된 앱 실행

```
❌ 변경 전: FastAPI(7701) + Socket.IO(별도 포트) → 연결 실패
✅ 변경 후: FastAPI + Socket.IO 통합(7701) → 정상 작동
```

---

### 2. WebSocket 연결 오류 (Socket.IO 중복 연결)

**문제 상황:**
- 화상회의 방에 입장할 때마다 Socket.IO 연결이 중복으로 생성됨
- 메시지가 여러 번 전송되거나 연결이 불안정해지는 문제

**해결 방법:**
- 방 입장 시 기존 연결이 있으면 재사용, 없으면 새로 생성
- 방 퇴장 시 연결 정리(cleanup) 로직 추가
- `socketRef.current?.connected` 체크로 중복 연결 방지

```
❌ 변경 전: 방 입장할 때마다 새 연결 생성 → 연결 누적
✅ 변경 후: 기존 연결 재사용 + 퇴장 시 정리 → 안정적 연결
```

---

### 3. 방 인원 표시 오류 (호스트 2명, 0명인 방 남아있음)

**문제 상황:**
- 방에 1명만 있는데 "호스트 2명"으로 표시
- 모든 사람이 나갔는데도 방이 목록에 남아있음 (0/100)
- 서버 재시작해도 이전 방 정보가 그대로 남아있음

**해결 방법:**
- **서버 시작 시** 모든 방을 `inactive` 상태로 초기화
- **방 퇴장 시** 남은 인원이 0명이면 자동으로 방 삭제
- 참가자 수를 실제 Socket.IO 룸 멤버 수와 동기화

```python
# 서버 시작 시 모든 방 비활성화
cursor.execute("UPDATE meetings SET status = 'inactive' WHERE status = 'active'")
```

```
❌ 변경 전: 유령 방이 계속 남아있음
✅ 변경 후: 서버 시작 시 초기화 + 0명 되면 자동 삭제
```

---

### 4. 화면 UI와 실제 인원 불일치

**문제 상황:**
- 대시보드에서 보이는 방 인원수와 실제 방 안의 인원수가 다름
- 방 목록이 실시간으로 갱신되지 않음

**해결 방법:**
- `room_list_updated` 이벤트로 **실시간 방 목록 갱신**
- 백업으로 **10초마다 자동 폴링** 추가
- 방 입장/퇴장 시 즉시 모든 클라이언트에게 알림

```
❌ 변경 전: 새로고침해야 방 목록 갱신됨
✅ 변경 후: 실시간 갱신 + 10초 폴링 백업
```

---

### 5. 다크모드/라이트모드 작동 안 함

**문제 상황:**
- 테마 전환 버튼을 눌러도 화면이 바뀌지 않음
- 일부 컴포넌트만 테마가 적용되고 나머지는 적용 안 됨
- CSS 구문 오류로 스타일이 깨짐

**해결 방법:**
- `html[data-theme]` 속성 기반 테마 시스템 통일
- 모든 페이지(Dashboard, Room, FileTransfer 등)에 테마 클래스 적용
- CSS 파일의 구문 오류 수정 (`#추가부분` 잘못된 주석, `@layer` 닫힘 태그)

```css
/* 잘못된 코드 */
#추가부분 { ... }  /* CSS에서 한글 ID 사용 불가 */

/* 수정된 코드 */
/* 추가부분 */
.dark-theme { ... }
```

```
❌ 변경 전: 테마 버튼 눌러도 변화 없음
✅ 변경 후: 전체 UI 테마 즉시 전환
```

---

### 6. 파일 전송 시 이전 파일 정보 오류

**문제 상황:**
- 파일을 여러 번 보내면 이전에 보낸 파일의 정보가 섞임
- 파일 크기, 해시값이 이전 파일 것으로 표시됨

**해결 방법:**
- 새 파일 선택 시 **이전 상태값 초기화**
- `receivedChunks` 배열을 전송 시작할 때마다 새로 생성
- 파일 메타데이터 리셋 로직 추가

```typescript
// 파일 선택 시 상태 초기화
const handleFileSelect = (file) => {
  setSelectedFile(file);
  setTransferStats(null);      // 이전 통계 초기화
  setVerificationResult(null); // 이전 검증 결과 초기화
  setAnalysisResult(null);     // 이전 분석 결과 초기화
};
```

```
❌ 변경 전: 두 번째 파일 보내면 첫 번째 파일 정보 표시
✅ 변경 후: 매번 새로운 파일 정보로 깨끗하게 표시
```

---

### 7. 재입장 시 카메라 검은 화면

**문제 상황:**
- 방을 나갔다가 다시 들어가면 카메라가 검은 화면으로 표시
- 새로고침해야만 카메라가 다시 작동

**해결 방법:**
- 방 입장 시 **미디어 트랙 상태 체크** (`readyState === 'live'`)
- 트랙이 종료된 상태면 **새로운 스트림 요청**
- 기존 종료된 스트림 정리 후 재요청

```typescript
// 트랙 상태 체크
const videoAlive = videoTrack && videoTrack.readyState === 'live';
if (!videoAlive) {
  // 새 스트림 요청
  stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
}
```

```
❌ 변경 전: 재입장 시 검은 화면
✅ 변경 후: 자동으로 카메라 재연결
```

---

### 8. 상대방 퇴장 시 내 화면이 검은색

**문제 상황:**
- 상대방이 나가면 상대방 화면뿐 아니라 내 화면까지 검은색으로 변함
- React의 setState 클로저 문제로 잘못된 상태 참조

**해결 방법:**
- `setParticipants` 콜백 패턴 사용
- 상대방 연결 종료 시 **해당 참가자만** 목록에서 제거

```typescript
// 콜백 패턴으로 안전하게 상태 업데이트
setParticipants(prev => prev.filter(p => p.userId !== leavingUserId));
```

```
❌ 변경 전: 상대방 나가면 내 화면도 영향받음
✅ 변경 후: 상대방만 정확히 제거, 내 화면 유지
```

---

### 9. 여러 명 접속 시 WebRTC 연결 문제

**문제 상황:**
- 3명 이상 접속 시 일부 참가자끼리 연결이 안 됨
- WebRTC P2P 연결이 불안정하게 끊어짐

**해결 방법:**
- `webrtc-native.ts`에서 ICE 연결 상태 관리 개선
- `RoomPage.tsx`에서 다중 연결 로직 수정
- 연결 실패 시 자동 재시도 로직 추가

```
❌ 변경 전: 3명 이상 접속 시 일부 연결 실패
✅ 변경 후: 다중 사용자 안정적 연결
```

---

### 10. 채팅 메시지 발신자에게도 중복 전송

**문제 상황:**
- 채팅 메시지 보내면 본인에게도 서버에서 다시 전송됨
- 같은 메시지가 2번 표시되는 문제

**해결 방법:**
- Socket.IO `skip_sid` 옵션으로 발신자 제외 브로드캐스트
- 프론트엔드에서 로컬 메시지 추가 후 서버는 다른 사람에게만 전송

```python
# 발신자 제외하고 브로드캐스트
await sio.emit('chat_message', message, room=room_id, skip_sid=sid)
```

```
❌ 변경 전: 내 메시지가 2번 표시됨
✅ 변경 후: 내 메시지는 1번만 표시
```

---

### 11. 필터 효과 백그라운드 탭에서 멈춤

**문제 상황:**
- 브라우저 탭을 다른 곳으로 이동하면 영상 필터 효과가 멈춤
- `requestAnimationFrame`이 백그라운드에서 동작 안 함

**해결 방법:**
- `requestAnimationFrame` → `setInterval`로 변경
- 백그라운드 탭에서도 필터 효과 계속 적용

```
❌ 변경 전: 탭 전환하면 필터 멈춤
✅ 변경 후: 백그라운드에서도 필터 정상 동작
```

---

### 12. 영상/오디오 효과 충돌

**문제 상황:**
- 영상 효과 적용 후 오디오 효과 적용하면 영상 효과가 사라짐
- 효과 적용할 때마다 전체 스트림이 덮어씌워짐

**해결 방법:**
- **토글형 즉시 적용** 방식으로 변경
- **비디오/오디오 트랙 독립 처리** (서로 영향 안 줌)
- `replaceTrack`으로 기존 연결 유지하면서 트랙만 교체

```
❌ 변경 전: 효과 적용 시 다른 효과 초기화됨
✅ 변경 후: 영상/오디오 효과 독립적으로 동시 적용 가능
```

---

## ✨ 추가한 기능

### 1. 다크모드 / 라이트모드

**기능 설명:**
- 화면 우측 상단 토글 버튼으로 **테마 즉시 전환**
- 사용자 선호에 따라 눈이 편한 모드 선택 가능

**구현 방식:**
- `html[data-theme='dark']` / `html[data-theme='light']` 속성 기반
- Tailwind CSS 커스텀 클래스로 테마별 스타일 분리
- 선택한 테마 로컬 스토리지에 저장 (새로고침해도 유지)

```
🌙 다크모드: 어두운 배경, 밝은 글씨 (Discord 스타일)
☀️ 라이트모드: 밝은 배경, 어두운 글씨 (일반 웹사이트 스타일)
```

---

### 2. 서버 시작 시 방 자동 삭제

**기능 설명:**
- 서버를 재시작하면 **이전에 남아있던 유령 방들 자동 정리**
- 항상 깨끗한 상태로 서버 시작

**구현 방식:**
- 서버 시작 시 데이터베이스의 모든 `active` 방을 `inactive`로 변경
- 실제 사용자가 없는 방이 목록에 남지 않음

```
서버 시작 → DB 조회 → 모든 active 방 → inactive로 변경 → 깨끗한 시작!
```

---

### 3. 웹캠 실시간 압축 품질 분석

**기능 설명:**
- 웹캠 영상을 **품질 1~100으로 압축**했을 때 화질이 얼마나 나빠지는지 측정
- **PSNR/SSIM** 품질 지표를 실시간 그래프로 시각화

**쉬운 설명:**
```
📷 웹캠에서 사진 한 장 찍음 (원본)
     ↓
🗜️ 품질 70%로 압축 (용량 줄임)
     ↓
📊 원본 vs 압축본 비교해서 점수 계산
     ↓
📈 그래프로 "이 정도 압축하면 화질이 이렇게 됩니다" 보여줌
```

**품질 지표 해석:**
| 지표 | 의미 | 좋은 값 |
|------|------|---------|
| **PSNR** | 얼마나 선명한가 (신호 대 잡음비) | 30dB 이상 |
| **SSIM** | 원본과 얼마나 비슷한가 | 0.9 이상 (1이 최고) |

---

### 4. 파일 전송 압축 기능

**기능 설명:**
- 이미지, 영상, 오디오 파일을 **전송 전에 압축**하여 빠르게 전송
- **품질 슬라이더**로 압축률 조절 가능
- 압축 전후 용량 비교 표시

**파일별 압축 방식:**
| 파일 종류 | 압축 방식 | 예시 |
|----------|----------|------|
| **이미지** | JPEG 압축 (Canvas) | 2MB → 400KB (80% 감소) |
| **영상** | H.264 압축 (FFmpeg) | 100MB → 30MB (70% 감소) |
| **오디오** | MP3 압축 (FFmpeg) | 50MB → 10MB (80% 감소) |

**품질 슬라이더 의미:**
```
100% = 거의 원본 품질 (용량 큼)
 70% = 눈에 차이 거의 없음 (권장)
 30% = 살짝 뭉개짐 (용량 작음)
```

---

### 5. 웹캠 실시간 효과

**기능 설명:**
- 화상회의 중 **실시간으로 영상/오디오 효과** 적용
- 토글 버튼으로 **즉시 적용/해제**
- 여러 효과 **동시 적용 가능**

**영상 효과 (10가지):**
| 카테고리 | 효과 | 설명 |
|----------|------|------|
| 기하 변환 | 좌우 반전 | 거울처럼 좌우가 바뀜 |
| 기하 변환 | 상하 반전 | 위아래가 뒤집힘 |
| 기하 변환 | 45° 전단 | 비스듬하게 기울어짐 |
| 기하 변환 | 90° 전단 | 극단적으로 기울어짐 |
| AI 필터 | 흑백 | 컬러 → 흑백 변환 |
| AI 필터 | 세피아 | 옛날 사진 느낌 (갈색 톤) |
| AI 필터 | 블러 | 흐릿하게 처리 |
| AI 필터 | 엣지 감지 | 윤곽선만 표시 |
| AI 필터 | 카툰 | 만화처럼 표현 |
| AI 필터 | 네온 | 형광 색상 효과 |

**오디오 효과 (3가지):**
| 효과 | 설명 |
|------|------|
| **Low Pass Filter** | 고음 제거 (뭉개진 소리) |
| **Echo** | 메아리 효과 (산에서 소리치는 느낌) |
| **Reverb** | 잔향 효과 (콘서트홀 느낌) |

---

## 👥 팀원별 기여

| 팀원 | GitHub ID | 주요 기여 |
|------|-----------|----------|
| **FN-Olofmeister** | jowan88 | Socket 오류 해결, 배포 설정, 프로젝트 관리 |
| **limjm1006** | limjm1617 | 다크모드/라이트모드, FileTransfer 개선, WebRTC 버그 수정 |
| **SDLulu** | 52689979 | 압축 품질 분석, 웹캠 효과, P0 버그 수정, 문서 작성 |

---

## 📅 작업 타임라인

| 날짜 | 주요 작업 |
|------|----------|
| 11/20 | 다크모드/라이트모드 기능 추가 (limjm1006) |
| 11/25 | 프로젝트 분석, Socket.IO 중복 연결 버그 수정 |
| 11/26 | 압축 품질 분석, 웹캠 실시간 효과 기능 구현 |
| 11/27 | P0 버그 5개 수정, 다크모드 통합, 테마 적용 |
| 11/28 | WebRTC 연결 버그 수정, 채팅/파일전송 개선 |
| 11/30 | 배포 설정, 추가 버그 수정 (1~11차) |
| 12/01 | backend/main.py 수정 |
| 12/03 | Socket 오류 해결, WebRTC 문제 해결, 여러명 접속 버그 수정 |
| 12/03 | 파일 전송 압축 기능 추가, 문서 정리 |

---

## 📊 변경 통계

- **총 커밋 수**: 약 35개
- **수정된 파일**: 50개 이상
- **추가된 코드**: 약 4,000줄
- **삭제된 코드**: 약 5,000줄 (불필요한 문서 정리)

---

## 🔗 관련 커밋

| 커밋 | 작성자 | 설명 |
|------|--------|------|
| `a2d221d` | SDLulu | 발표용 버그 수정 및 기능 추가 내역 문서 작성 |
| `bf6bfd6` | SDLulu | 압축 품질 분석 개선 및 파일 전송 압축 기능 추가 |
| `702f305` | SDLulu | WebRTC 연결, 채팅, 파일전송, 필터효과 버그 수정 |
| `2cd6720` | limjm1006 | 여러명 접속 버그 수정 |
| `4e1eea8` | limjm1006 | WebRTC 문제 해결(1) |
| `709132d` | FN-Olofmeister | socket 오류 해결 |
| `8afe807` | SDLulu | P0 버그 5개 수정 + UI 테마 적용 |
| `13e8d92` | SDLulu | 압축 품질 분석 및 웹캠 실시간 효과 기능 추가 |
| `52698eb` | SDLulu | 웹캠 실시간 효과 버그 수정 |
| `3deff13` | SDLulu | 프로젝트 정리 및 코드 개선 |
| `489f423` | limjm1006 | 다크모드/라이트모드 AuthContext 추가 |
| `9a0e522` | limjm1006 | DashboardPage 테마 적용 |
| `3c219f8` | limjm1006 | index.css 테마 스타일 추가 |

---

*작성일: 2025-12-03*
